<!DOCTYPE html>
<html>
<head>
    <title>WSO2 DOD - Sign In</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,500' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css"/>
    <link href="css/themes/dod.css" rel="stylesheet"/>
    <link href="css/jquery.mobile.icons.min.css" rel="stylesheet"/>
    <link href="css/jquery.mobile.structure-1.4.5.min.css" rel="stylesheet"/>
    <link href="css/app.css" rel="stylesheet"/>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/googlesignin.js"></script>
    <script type="text/javascript" src="js/jquery.blockUI.js"></script>-
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>-
    <script type="text/javascript" charset="utf-8">
       $(document).on('deviceready',function() 
    	{
            var order_detail ={};
            var d1 = new $.Deferred();
            var d2 = new $.Deferred();
            var d4 = new $.Deferred();
            userDetailChek();
             
            $(document).ajaxStop(function(){
                userDetailChek();
            }); 

            $("#btn-login-google").click(function(){
                 callGoogle();
            });

            var viewLoader  = function(){
                $.blockUI({ css: { 
                        border: 'none', 
                        padding: '15px', 
                        backgroundColor: '#000', 
                        '-webkit-border-radius': '10px', 
                        '-moz-border-radius': '10px', 
                        opacity: .5, 
                        color: '#fff' 
                    } 
                });
            }

            $("#btn-submit").click(function(){
                loadVendors();
                viewLoader();
                $.when(d1,d2).done(function (){
                    $.unblockUI;
                    localStorage.setItem("items",JSON.stringify(order_detail));
                    localStorage.removeItem("order_details");
                    $(location).attr('href','placeOrder.html');

                });               
                
            });
            /*$(this).queue(function() {
        $("#login_menu").slideUp();
        $(this).dequeue();
    }).queue(function() {
        $('.login_menu_arrow.top').hide();
        $(this).dequeue();
    }).queue(function() {
        $('.login_menu_arrow.bottom').show();
        $(this).dequeue();
    });*/   var clickCallbacks = $.Callbacks();
            var loadVendors = function(){
                cordova.exec (function(vendors) {            
                   storeVendors(vendors);
                   d1.resolve();
                }, function(error) {
                    //$.mobile.loading( 'hide',function(){});
                    alert("error : "+error);
                }, "Controller", "LoadVendors",[userName,"password"]);
                return d1.promise();                
                //d2.resolve();
            }

            var storeVendors = function(vendors){
                var vendorName = "";
                var j = 1;
                //clickCallbacks.add(loadItems);
                $.each( vendors, function(i, row) {
                    console.log("vendors"+row)
                    order_detail[row] ={};        
                    loadItems(row).done(function(menu){
                        order_detail[row] = menu;
                        //alert(Object.keys(vendors).length+" length")
                        //alert(JSON.stringify(order_detail));
                        if(Object.keys(vendors).length == j){
                          d2.resolve();
                        }else{
                          j++;    
                        }
                    });
                    //clickCallbacks.fire(row);
                    //setTimeout( loadItems(row),3000 ); 
                    
                });
                //alert("function done");
                return d2.promise();
            }
                
            var loadItems = function (vendor){   
                var d3 = new $.Deferred();                
                cordova.exec (function(menu) { 
                    //order_detail[vendor] = menu;  
                    //alert(vendor+" : "+menu);
                    d3.resolve(menu);
                }, function(error) {
                        alert(error);
                }, "Controller", "LoadMenu",[userName,"",vendor]);
                return d3.promise();
            }

        });         
    </script>
</head>
<body id="signPageBody">
    <div data-role="page" id="signIn">
        <div id="imgContainer">
            <img src="img/logo.png"/>
        </div>
        <div role="main" class="ui-content">
           
           <div id="logInForm" class="center-wrapper">
            <input type="text" name="txt-email" id="txt-email" value="" placeholder="Email" maxlength="20">
            <!--<input type="password" name="txt-password" id="txt-password" value="" placeholder="Password">-->
            
            <!--  direction to place Order page -->
            <a href="#" rel="external" id="btn-submit" class="ui-btn ui-btn-c ui-corner-all mc-top-margin-1-5">Proceed With Current Login</a>
            <a href="#" rel="external" id="btn-login-google" class="ui-btn ui-btn-c ui-corner-all mc-top-margin-1-5">Sign In With GOOGLE</a>
            </div>
            <!--  label for incorrect credentials -->
            <!-- </br>
            <div class="center-wrapper">
                <label class="text-danger" for="errorMsg">Please enter correct credentials</label>
            </div> -->
        </div><!-- /content -->
    </div><!-- /page -->
</body>
</html>
